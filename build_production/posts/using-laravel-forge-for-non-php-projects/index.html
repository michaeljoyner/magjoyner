<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Using Laravel Forge for for a Node app</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=01254c26c8796fca9042">
        <link href="https://fonts.googleapis.com/css?family=Montserrat:700|Roboto+Slab:300" rel="stylesheet">
    </head>
    <body class="font-serif text-black pt-20 leading-normal">
        <header class="flex justify-between p-4 shadow fixed pin-t w-full bg-white">
    <div class="font-sans">
        <a href="/" class="no-underline font-black text-xl">
        <span class="text-grey">MAG</span><span class="text-black">JOYNER</span>
        </a>
    </div>
    <div>
        <a class="no-underline text-black hover:text-red" href="https://github.com/michaeljoyner">
        <svg aria-labelledby="simpleicons-github-icon" role="img" viewBox="0 0 24 24" height="24px" class="fill-current" xmlns="http://www.w3.org/2000/svg"><title id="simpleicons-github-icon">GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
        </a>
    </div>
</header>        <div class="px-4 max-w-lg mx-auto lg:text-xl">
            <div class="mb-4">
                <h1 class="text-3xl font-black font-sans pb-2 capitalize lg:text-5xl">Using Laravel Forge for for a Node app</h1>
                <p class="uppercase text-xs tracking-wide font-bold text-grey-dark">31 August 2018</p>
            </div>
            <div class="my-8 p-4 bg-purple-lightest">
                <p class="uppercase text-xs tracking-wide font-bold text-black">In a Nutshell</p>
                <p class="mt-4">Laravel Forge has some awesome features that can be leveraged for non-Laravel/PHP apps. Learn how to setup a Node app for easy deployment, SSL and more.</p>
            </div>
            <h3 class="heading">For whom may this be?</h3>
<p>Forge has some great features that we will take advantage of, but it is really aimed at Laravel/PHP apps. So if you are planning on a large scale, big money Node project, maybe you should find a more specialized solution. However, if you are already a Forge user and have some server space to spare, and find yourself with a Node itch to scratch, read on.</p>
<h3 class="heading">Before we begin</h3>
<p>To follow along, you will need a <a href="https://forge.laravel.com">Forge</a> account, with a server already provisioned. If you haven't done that part, do it now quickly, just provision the smallest, cheapest server for now. You will also need your sudo password for the server.</p>
<p>For this tutorial we will be using a simple Node app with two endpoints. The <code>/</code> endpoint just displays &quot;hello world&quot;, and the <code>/env</code> endpoint shows the value of an environment variable. It will become clear why at a later point. So grab the <a href="https://github.com/michaeljoyner/forge-node-test">app from GitHub</a> and we can get started.</p>
<h3 class="heading">Step One: Installation</h3>
<p>Head over to your Forge server and add a new site on the server. If you are going to want to add SSL to the site, make sure you use the correct domain name as the site name, otherwise just give it any reasonable name. Once the site has been created, go to the site's page on Forge and you can install your repo from Github by clicking on the Git repository button. Fill out the neccessary fields and make sure to uncheck the &quot;Install Composer dependancies&quot; checkbox.</p>
<p>If all went well, Forge will have now set up all the site's directories and nginx stuff on our server.</p>
<h3 class="heading">Step Two: Nginx</h3>
<p>Forge was kind enough to setup all the Nginx stuff for us, but we will need to make some changes. On your site's page in Forge, look for the &quot;files&quot; button at the bottom and select &quot;Edit Nginx Configuration&quot;. This will open a modal with your nginx config for the site. You need to find the following:</p>
<pre><code class="language-nginx">location / {
 try_files $uri $uri/ /index.php?$query_string;
}</code></pre>
<p>and replace it with:</p>
<pre><code class="language-nginx">location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}</code></pre>
<p>This will make sure requests sent to your site will be forwarded to the port where Node will be listening. You can also delete some of the other PHP related stuff, or if you are not sure, just leave it there.</p>
<p>If you are going to be using your own domain (as opposed to just the IP address), you may as well set that up now. Go ahead and log into your domain registrar and create an A record pointing your domain (or subdomain) to the server's IP address. If you are just going to use the IP address, you may need to make one more change to your nginx file.</p>
<p>Find the line:</p>
<pre><code class="language-nginx">listen 80;</code></pre>
<p>and change it to</p>
<pre><code class="language-nginx">listen 80 default_server;</code></pre>
<p>If you aleready have another site on the same server that acts as the default server, then you can change the servename in the nginx config from your domain name to the IP address.</p>
<h3 class="heading">Step Three: Environment Variables</h3>
<p>Forge allows us to change the environment variables through its UI, giving us an easy way to edit the <code>.env</code> file which lives at the root of our site. From your site page on Forge, go to the Environment tab and click on &quot;Edit environment&quot;. Add the following:</p>
<pre><code class="language-yaml">SECRET_MESSAGE="Forge is great"</code></pre>
<h3 class="heading">Step Four: Test our work so far</h3>
<p>If you visit your domain (or IP address) now, you should see an Nginx error page. That is because we haven't actually started the app. In order to check that what we have done so far works, first ssh into your server and navigate into your site's directory.</p>
<p>First run <code>npm install</code> to pull in our dependencies. Then run <code>node index.js</code>. You should see the message in your console to tell you that it is listening on port 3000.</p>
<p>Now if you go to your domain, you should see the hello world message, and if you visit the <code>/env</code> endpoint, you should see the secret message stored in your environment variable.</p>
<p>Once you are happy that is all working, press Ctrl+C to stop the process. Your app was running, but it isn't quite ready for the big time yet.</p>
<h3 class="heading">Intermission</h3>
<p>Unlike your Laravel apps, the Node app will continue to run in its own process, continuously serving requests as they come in. A new process does not start for each request. This has implications for how we need to run our Node app. If the process running our app dies, any request to our app will fail. So we need a way to monitor the process, and restart it if neccessary. Additionally, seeing as your environment variables are read only when the app starts up, and not for each request, you need to restart the process when we make changes to our environment variables, and generally when we deploy.</p>
<p>Luckily, Forge comes with an easy way to manage and monitor a process as a daemon, because they are exactly what it needs for Laravel's queueing functionality. Our stratergy will be to create a daemon that is monitored and will be restared if the process dies, the server restarts, etc. We will also set it to restart on each deploy.</p>
<h3 class="heading">Step five: The daemon</h3>
<p>When we ssh'ed into our server and ran our app manually, everything worked out just fine. This is because we use the dotenv library to manage our environment variables, and by default it will read the <code>.env</code> file in the current working directory. However, using Forge's daemon function, the app won't be started from the site's home directory, so the <code>.env</code> file can't be loaded. So we can hard code in the path to the <code>.env</code> file and pass it into the dotenv config in our app, but we also need to think how that will effect your local workflow. Another option, which we will go with, is to use a small bash script to startup our app. The daemon will then run that script. See the startup.sh script in the project root.</p>
<p>First, open the Node app we are using in your editor of choice, and edit the <code>startup.sh</code> file. You need to change the following line:</p>
<pre><code>cd /home/forge/node-on-forge</code></pre>
<p>to use the correct directory, as such:</p>
<pre><code>cd /home/forge/[NAME-OF-YOUR-FORGE-SITE]</code></pre>
<p>Commit your changes and ssh into the server, go to your site's home directory and pull in those changes.</p>
<p>Now go to the server page in Forge, and click on the Daemons tab. Enter the following into the command field: <code>bash /home/forge/[your-site-name]/startup.sh</code>. Leave it as only one process and leave the directory field blank. Then add the daemon. Once the daemon is created you may click on the little eye icon to see the status. It should be running.</p>
<p>Forge has now created the daemon and done all the Suepvisor (a process manager) setup and config for us. But we will need to make some small changes. While you are in the daemon screen, take note of the daemon ID number, you'll need it later.</p>
<h3 class="heading">Step six: Supervisor config and sudo</h3>
<p>There are two issues we have now. If the daemon is stopped for some reason, the child process that is our actuall app does not get stopped, to it is still running and occupying port 3000, and our daemon won't be able to restart. So it is time to ssh back into your server.</p>
<p>Use nano or vim to edit <code>/etc/supervisor/conf.d/daemon-[YOUR-DAEMON-ID]</code> as sudo. You will see something like this:</p>
<pre><code>[program:daemon-42928]
command=bash /home/forge/[YOUR-SITE-NAME]/startup.sh

process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
user=forge
numprocs=1
redirect_stderr=true
stdout_logfile=/home/forge/.forge/daemon-42928.log</code></pre>
<p>You need to add the following: <code>stopasgroup=true</code> on the last line, so now it should look as such:</p>
<pre><code>[program:daemon-42928]
command=bash /home/forge/[YOUR-SITE-NAME]/startup.sh

process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
user=forge
numprocs=1
redirect_stderr=true
stdout_logfile=/home/forge/.forge/daemon-42928.log
stopasgroup=true</code></pre>
<p>Save the file and then run <code>sudo supervisorctl update</code> to enable your changes.</p>
<p>If you check on the status of your daemon now, it probably won't be running. Go to the bottom of the page on Forge, look for the &quot;Restart&quot; button and restart the server. That should fix things.</p>
<p>The remaining problem is that we need to be able to retsart the daemon in our deploy script, but that requires sudo priveleges. So we are going to make it so that the forge user can run the <code>supervisorctl</code> command as sudo without being prompted for the sudo password.</p>
<p>Ssh back into your server, and run the following command: <code>sudo visudo</code>. This will open a sudo config file in your default editor (on the server, so probably either nano or vi). Add the following to the very bottom of the file, on a new line: <code>forge ALL=(ALL) NOPASSWD: /usr/bin/supervisorctl</code>. Save your changes and exit. Now you may exit your server. I don't know if it is entirely neccesary, but you may restart the server from the server page on Forge.</p>
<h3 class="heading">Step seven: The deploy script</h3>
<p>Now we are ready to make our deploy script from the app tab on the sites page in Forge. At the very least, we need to pull in the latest version from git, install any node dependancies and restart the daemon. You could start out with something like this:</p>
<pre><code>cd /home/forge/[YOUR-SITE-NAME]
git pull origin master
npm install
sudo supervisorctl restart daemon-[YOUR-DAEMON-ID]:daemon-[YOUR-DAEMON-ID]_00</code></pre>
<p>Now click on the deploy button. Once it is done, click the &quot;View Latest Deployment Log&quot; to see if everything worked properly.</p>
<p>Once it is all working, in Forge go to your site's environment variables and change the SECRET_MESSAGE. Save the changes, and go to the <code>/env</code> endpoint in your browser. You should still see the old message. Hopefully this makes sense to you now. So you need to remember that whenever you update your environment variables, you need to either redeploy the app or just restart the daemon using the Forge UI.</p>
<h3 class="heading">Step Eight: Get that sweet SSL</h3>
<p>As the final piece of the puzzle, as long as you are actually putting this under a real domain name, you may head over to the SSL tab in Forge and set that up just as you would for any other app. If you are using Let's Encrypt, Forge will take care of everything for you, which is absolutely wonderful.</p>
<h3 class="heading">Wrapping Up</h3>
<p>Initially, this may seem like a lot of work just to get a Node app up and running, but it really isn't. Once you are familiar with the process it will seem very quick and easy, and there are some huge benefits. Forge also has other features that can be used for non-Laravel apps, such as the Schedule tab, which provides an easy way to manage cron jobs. There is also a way to manage databases if you want to use a MySQL (or similar) database.</p>
<p>There are also ways this setup could be improved, this is really intended as a starting point. I am no expert in any of this stuff, so feel free to double-check on anything I say, or if there is anything I am missing out on, send me an email. I hope this helps though.</p>        </div>
        <script src="/assets/build/js/main.js?id=bec1fb078a2fd07a5c8f"></script>
    </body>
</html>

